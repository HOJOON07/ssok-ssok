# 타임라인 격리하기

## 살펴볼 내용

1. 코드를 타임라인으로 그리기
2. 버그를 찾기 위해 타임라인 다이어그램 보는 법을 이해하기
3. 타임라인끼리 공유하는 자원을 줄여 코드 설계를 개선하는 방법을 알아봅니다.

### 장바구니 계산에서 클릭하는 속도에 따라서 결제 금액이 달라지는 버그?

- 순서대로 실행되는 액션과 동시에 나란히 실행되는 액션 때문

## 두 가지 타임라인으로 바꿀 때 기본 규칙

- 두 액션이 순서대로 나타나면 같은 타임라인에 넣는다.
- 두 액션이 동시에 실행되거나 순서를 예상할 수 없다면 분리된 타임라인에 넣습니다.

### 인자는 함수를 부르기 전에 실행한다.

- 함수에 인자를 전달하면서 실행한다면 인자는 함수에 전달되기 전에 실행된다.

### add-to-cart 타임라인 그리기

- 비동기 콜백이 어떻게 동작하는지 아는 것은 매우 중요하다.

```js
saveUserAjax(user, function () {
  setUserLoadingDOM(false);
});

setUserLoadingDOM(true);

saveDocumentAjax(document, function () {
  setDocLoadingDOM(false);
});

setDocLoadingDOM(true);
```

#### 타임라인 다이어그램으로 동시에 실행되는 코드는 순서를 예측할 수 없다는 것을 알 수 있다.

### 좋은 타임라인의 원칙

- 타임라인은 적을수록 이해하기 쉽다.
  - 타임라인이 하나인 시스템이 가장 이해하기 쉽다.
- 타임라인은 짧을수록 이해하기 쉽다.
  - 단계를 줄인다면 실행가능한 순서의 수도 줄어든다.
- 공유하는 자원이 적을수록 이해하기 쉽다.
  - 서로 자원을 공유하지 않는다면 실행 순서를 신경쓸 필요가 없다.
- 자원을 공유한다면 서로 조율해야 한다.
  - 없앨 수 없는 공유자원은 어쩔 수 없다. 안전한게 공유하는 것이 중요하다.
- 시간을 일급으로 다룬다.
  - 타임라인을 다루는 재사용 가능한 객체를 만들면 타이밍 문제를 쉽게 만들 수 있다.

### 타임라인 단순화 하기

1. saveUserAjax
2. setUserLoadingDOM (false)
3. setUserLoadingDOM (true)
4. saveDocumentAjax
5. setDocLoadingDOM (false)
6. setDocLoadingDOM (true)

#### 1.하나의 타임라인에 있는 모든 액션을 하나로 통합한다.

#### 2.타임라인이 끝나는 곳에서 새로운 타임라인이 하나 생긴다면 통합한다.

- ajax 호출을 하면서 끝나고 콜백 하나가 다음 작업을 이어서 한다 => 모든 타임라인을 하나의 타임라인으로 합칠 수 있다.

### 타임라인을 정리해보면 실행 순서를 보장할 수 없다는 것을 알게 된다.

- 장바구니 계산에서 클릭하는 속도에 따라서 결제 금액이 달라지는 버그?
  > 공유하는 자원을 없애 문제를 해결한다.

### 문제 해결

- 지역변수로 바꿀 수 있는 전역변수를 찾고 지역변수로 바꾼다.
- 암묵적 입력을 없애자.

### 비동기 호출에서 명시적인 출력을 위해 리턴값 대신 콜백을 사용할 수 있다.
